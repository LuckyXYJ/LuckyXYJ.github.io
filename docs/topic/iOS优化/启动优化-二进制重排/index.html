<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>启动优化-二进制重排 | LuckyXYJ</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" type="image/x-icon" href="/logo.svg">
    <meta name="description" content="iOS开发者个人成长笔记">
    
    <link rel="preload" href="/assets/css/0.styles.60aa9f3b.css" as="style"><link rel="preload" href="/assets/js/app.93bd62be.js" as="script"><link rel="preload" href="/assets/js/2.7f06bbfc.js" as="script"><link rel="preload" href="/assets/js/45.6248b108.js" as="script"><link rel="prefetch" href="/assets/js/10.5ff67019.js"><link rel="prefetch" href="/assets/js/11.81afa591.js"><link rel="prefetch" href="/assets/js/12.99386db7.js"><link rel="prefetch" href="/assets/js/13.3ddbaf04.js"><link rel="prefetch" href="/assets/js/14.f858a8d6.js"><link rel="prefetch" href="/assets/js/15.6cc80679.js"><link rel="prefetch" href="/assets/js/16.d652e140.js"><link rel="prefetch" href="/assets/js/17.99488e07.js"><link rel="prefetch" href="/assets/js/18.4ce4ddfc.js"><link rel="prefetch" href="/assets/js/19.1d851806.js"><link rel="prefetch" href="/assets/js/20.fbb4adcc.js"><link rel="prefetch" href="/assets/js/21.b0908f98.js"><link rel="prefetch" href="/assets/js/22.735788eb.js"><link rel="prefetch" href="/assets/js/23.f691c1c2.js"><link rel="prefetch" href="/assets/js/24.38fb0d6c.js"><link rel="prefetch" href="/assets/js/25.ae5ef7d0.js"><link rel="prefetch" href="/assets/js/26.5e0e8f67.js"><link rel="prefetch" href="/assets/js/27.2201a7c8.js"><link rel="prefetch" href="/assets/js/28.f706ff0e.js"><link rel="prefetch" href="/assets/js/29.17754718.js"><link rel="prefetch" href="/assets/js/3.e9a491ab.js"><link rel="prefetch" href="/assets/js/30.20315715.js"><link rel="prefetch" href="/assets/js/31.c68a8a46.js"><link rel="prefetch" href="/assets/js/32.2fdb82be.js"><link rel="prefetch" href="/assets/js/33.86c114fb.js"><link rel="prefetch" href="/assets/js/34.4ffe0c7a.js"><link rel="prefetch" href="/assets/js/35.a1a8fbda.js"><link rel="prefetch" href="/assets/js/36.bca84e47.js"><link rel="prefetch" href="/assets/js/37.93db8a26.js"><link rel="prefetch" href="/assets/js/38.c30ed749.js"><link rel="prefetch" href="/assets/js/39.ee8c4957.js"><link rel="prefetch" href="/assets/js/4.90a7f436.js"><link rel="prefetch" href="/assets/js/40.5fd6a0d5.js"><link rel="prefetch" href="/assets/js/41.a42ed2da.js"><link rel="prefetch" href="/assets/js/42.546aacca.js"><link rel="prefetch" href="/assets/js/43.b58daf24.js"><link rel="prefetch" href="/assets/js/44.8a0aa281.js"><link rel="prefetch" href="/assets/js/46.1540adc2.js"><link rel="prefetch" href="/assets/js/47.266e0f38.js"><link rel="prefetch" href="/assets/js/48.82836bb4.js"><link rel="prefetch" href="/assets/js/49.5c16abdd.js"><link rel="prefetch" href="/assets/js/5.e06e4dfd.js"><link rel="prefetch" href="/assets/js/50.51aced50.js"><link rel="prefetch" href="/assets/js/51.96343df1.js"><link rel="prefetch" href="/assets/js/52.6d447ecd.js"><link rel="prefetch" href="/assets/js/53.0f7ad62b.js"><link rel="prefetch" href="/assets/js/54.9999a53e.js"><link rel="prefetch" href="/assets/js/55.6281f507.js"><link rel="prefetch" href="/assets/js/56.e15e01af.js"><link rel="prefetch" href="/assets/js/57.a2f87232.js"><link rel="prefetch" href="/assets/js/58.0ba8755d.js"><link rel="prefetch" href="/assets/js/59.76deb41d.js"><link rel="prefetch" href="/assets/js/6.b8cd14ef.js"><link rel="prefetch" href="/assets/js/60.963519f3.js"><link rel="prefetch" href="/assets/js/61.c46d7866.js"><link rel="prefetch" href="/assets/js/7.70113771.js"><link rel="prefetch" href="/assets/js/8.18ca1413.js"><link rel="prefetch" href="/assets/js/9.7081022d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.60aa9f3b.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">LuckyXYJ</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/?category=posts.html" class="nav-link">博客</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><!----> <span class="title" style="display:;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topic/iOS优化/" class="nav-link">OS优化</a></li><li class="dropdown-item"><!----> <a href="/topic/Objective-C/" class="nav-link">Objective-C</a></li><li class="dropdown-item"><!----> <a href="/topic/Swift/" class="nav-link">Swift</a></li><li class="dropdown-item"><!----> <a href="/topic/网络协议/" class="nav-link">网络协议</a></li><li class="dropdown-item"><!----> <a href="/topic/音视频/" class="nav-link">音视频</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/LuckyXYJ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="http://xingyajie.tech/atom.xml" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rss
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/?category=posts.html" class="nav-link">博客</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专题" class="dropdown-title"><!----> <span class="title" style="display:;">专题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/topic/iOS优化/" class="nav-link">OS优化</a></li><li class="dropdown-item"><!----> <a href="/topic/Objective-C/" class="nav-link">Objective-C</a></li><li class="dropdown-item"><!----> <a href="/topic/Swift/" class="nav-link">Swift</a></li><li class="dropdown-item"><!----> <a href="/topic/网络协议/" class="nav-link">网络协议</a></li><li class="dropdown-item"><!----> <a href="/topic/音视频/" class="nav-link">音视频</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/LuckyXYJ" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="http://xingyajie.tech/atom.xml" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Rss
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/topic/iOS%E4%BC%98%E5%8C%96/" aria-current="page" class="sidebar-link">OS优化</a></li><li><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%8C%85%E5%A4%A7%E5%B0%8F%E4%BC%98%E5%8C%96/" class="sidebar-link">包大小优化</a></li><li><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/" aria-current="page" class="active sidebar-link">启动优化-二进制重排</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/#启动过程" class="sidebar-link">启动过程</a></li><li class="sidebar-sub-header level2"><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/#pre-main阶段" class="sidebar-link">pre-main阶段</a></li><li class="sidebar-sub-header level2"><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/#main阶段" class="sidebar-link">main阶段</a></li><li class="sidebar-sub-header level2"><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/#二进制重排" class="sidebar-link">二进制重排</a></li><li class="sidebar-sub-header level2"><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/" class="sidebar-link">卡顿优化</a></li><li><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/" class="sidebar-link">启动优化</a></li><li><a href="/topic/iOS%E4%BC%98%E5%8C%96/%E8%80%97%E7%94%B5%E4%BC%98%E5%8C%96/" class="sidebar-link">耗电优化</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=topic" title="分类" data-v-06225672>topic</a></li><li data-v-06225672><a href="/categories/?category=iOS%E4%BC%98%E5%8C%96" title="分类" data-v-06225672>iOS优化</a></li><li data-v-06225672><a href="/categories/?category=%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96-%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92" title="分类" data-v-06225672>启动优化-二进制重排</a></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-02-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">启动优化-二进制重排<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>新接手的项目启动速度贼慢，加上电脑性能太差，每次修改代码后启动都要等很久，所有产生了优化一下启动速度的想法</p> <h2 id="启动过程"><a href="#启动过程" class="header-anchor">#</a> 启动过程</h2> <p>启动的过程可以认为是用户点击app图标到第一个界面显示出来的过程。启动又分为<strong>冷启动</strong>和<strong>热启动</strong>，所谓冷热启动的区别无非就是从0到2。从1到2。冷启动是内存中没有应用相关数据，全部是重新加载的过程。热启动就是内存中有应用相关数据，部分重新加载过程。本文做的是冷启动的优化</p> <p>启动过程分为<strong>pre-main</strong>,<strong>main</strong>两个阶段，即main函数之前的加载过程，main函数之后到收个界面显示出来的过程。下面是关于两个阶段启动耗时的计算，优化方案</p> <h2 id="pre-main阶段"><a href="#pre-main阶段" class="header-anchor">#</a> pre-main阶段</h2> <p>该阶段的耗时测量，系统已提供了方法，可以通过设置Scheme内的环境变量DYLD_PRINT_STATISTICS为YES，在启动的时候可以打印出来相应的耗时。</p> <p><img src="http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/1240.jpeg" alt="启动时间配置.png"></p> <p>​<img src="http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20230220181834174.png" alt="image-20230220181834174">​</p> <p>由图中可以看出应用耗时分为四个阶段，四个阶段所作工作如下</p> <ul><li>1、dylib loading time：这个阶段主要是加载动态库</li> <li>2、rebase/binding time：偏移修正，符号绑定的过程</li> <li>3、ObjC setup time：OC类注册</li> <li>4、initializer time：这个阶段执行load，C++构造函数</li></ul> <h4 id="rebase-binding解释"><a href="#rebase-binding解释" class="header-anchor">#</a> rebase/binding解释</h4> <p>rebase：在App启动过程中会生成一个随机值ASLR，App方法、函数在内存中的地址 = 二进制文件中的偏移地址 + ASLR</p> <p>binding：地址与符号进行绑定</p> <h4 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h4> <p>根据以上四个阶段的介绍，可以得出以下几个优化方向
1、减少动态库。网上看到文章说苹果官方建自定义动态库最好不超过6个，待验证，反正我没看到官方建议在哪，但是看其他大型应用好像确实是6个动态库。如果有很多动态库可以考虑将动态库进行合并</p> <p>2、减少OC类。通常开发过程中为了解耦，为了代码更清晰，为了代码的复用，等等，我们才会把类进行拆分，总不能再为了优化启动时间把代码改回去，况且有人统计过2万个类大约增加800毫秒左右的启动时间。所以这个优化方向可以优化掉的启动时间的并不多。我们只能把项目迭代中产生的用不上，又不舍得删的代码删掉。</p> <p>3、用dispatchonce()代替所有的__attribute__((constructor '解析引用锚文本失败，请尝试更新该引用指向的定义块后再重新打开该文档'))函数、C++静态对象初始化、ObjC的+load。如果是swift，尽量使用struct</p> <h2 id="main阶段"><a href="#main阶段" class="header-anchor">#</a> main阶段</h2> <p>main阶段耗时计算方案：通过代码记录进入main函数时的时间，以及进入didFinishLaunching方法或者第一个页面viewDidAppear方法的时间，然后计算两个时间的时间差。</p> <p>这个阶段主要是执行我们写的各种业务代码，有很多并不是必须在这里立即执行的，这种业务我们可以采取延迟加载，防止影响启动时间。</p> <h4 id="优化方案"><a href="#优化方案" class="header-anchor">#</a> 优化方案</h4> <p>1、非重要业务，延迟操作
2、多线程执行
3、懒加载
4、压缩图片资源</p> <h2 id="二进制重排"><a href="#二进制重排" class="header-anchor">#</a> 二进制重排</h2> <p>除了以上提到的优化方案，通过抖音团队的文章，也了解到另一种解决方案，即二进制重排。原理可以看原文<a href="https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&amp;mid=2247485101&amp;idx=1&amp;sn=abbbb6da1aba37a04047fc210363bcc9&amp;chksm=e9d0cd4fdea7445989cf26623a16fc8ce2876bf3bda95a5532bb0e5e5b1420765653df0b94d1&amp;mpshare=1&amp;scene=1&amp;srcid=0316fLf0VRLHLhRPFDH6LuQo&amp;sharer_sharetime=1595570815854&amp;sharer_shareid=ff29c649ff1b5cea91081f325b5ada59#rd" target="_blank" rel="noopener noreferrer">抖音研发实践<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>原文里面对虚拟内存原理，Page Fault，order_file配置都有详细的介绍，我们要减少Page Fault次数，关键点就在于获取启动时用到的函数。本文介绍编译期插桩等方案来进行100%的符号覆盖，让重排达到最优效果。</p> <h4 id="clang-插桩"><a href="#clang-插桩" class="header-anchor">#</a> Clang 插桩</h4> <p>llvm内置了一个简单的代码覆盖率检测（SanitizerCoverage）。它在函数级、基本块级和边缘级插入对用户定义函数的调用。我们这里借助于SanitizerCoverage进行插桩。可以看文档<a href="https://clang.llvm.org/docs/SanitizerCoverage.html" target="_blank" rel="noopener noreferrer">Clang 13 documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="步骤"><a href="#步骤" class="header-anchor">#</a> 步骤</h4> <p>1、TARGETS --&gt; Build Settings --&gt; Other C Flags ---&gt; 添加 -fsanitize-coverage=func,trace-pc-guard</p> <div class="language- extra-class"><pre><code>如果是Swift项目的话，还需要额外在 Other Swift Flags 中加入-sanitize-coverage=func 和 -sanitize=undefined
</code></pre></div><p><img src="http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/1240-20221209213857657.png" alt="插桩.png"></p> <p>2、由于我们项目大量使用rn开发，连接了很多二进制文件。每个二进制文件又需要单独开启SanitizerCoverage，这里通过修改podfile来配置</p> <div class="language- extra-class"><pre class="language-text"><code>post_install do |installer|
  
  installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['OTHER_CFLAGS'] = '-fsanitize-coverage=func,trace-pc-guard'
        config.build_settings['OTHER_SWIFT_FLAGS'] = '-sanitize-coverage=func -sanitize=undefined'
      end
    end
end
</code></pre></div><p>3、重写两个方法
添加-fsanitize-coverage=func,trace-pc-guard之后，必须要实现两个方法一下是文档中方法</p> <div class="language- extra-class"><pre class="language-text"><code>extern &quot;C&quot; void __sanitizer_cov_trace_pc_guard_init(uint32_t *start,
                                                    uint32_t *stop) {
  
}
</code></pre></div><p>两个参数分别是符号表开始与结束的地址，</p> <div class="language- extra-class"><pre class="language-text"><code>extern &quot;C&quot; void __sanitizer_cov_trace_pc_guard(uint32_t *guard) {
  
}
</code></pre></div><p>guard参数相当于一个哨兵，告诉我们是第几个被调用的</p> <p>我在第二个方法里将每个符号加入原子队列，具体代码如下</p> <div class="language- extra-class"><pre class="language-text"><code>static OSQueueHead symbolHead = OS_ATOMIC_QUEUE_INIT;

typedef struct{
    void *pc;
    void *next;
} SYMNode;

void __sanitizer_cov_trace_pc_guard(uint32_t *guard) {

    void *PC = __builtin_return_address(0);
    
    SYMNode * node = malloc(sizeof(SYMNode));
    *node = (SYMNode){PC,NULL};

    OSAtomicEnqueue(&amp;symbolHead, node, offsetof(SYMNode, next));
}
</code></pre></div><p>4、获取所有的符号，并写入文件，代码如下</p> <div class="language- extra-class"><pre class="language-text"><code>+(void)creatOrderFile {
    //定义数组
    NSMutableArray *symbolNames = [NSMutableArray array];
    
    while (YES) {
       SYMNode * node = OSAtomicDequeue(&amp;symbolHead, offsetof(SYMNode, next));
        if (node == NULL) {
            break;
        }
        Dl_info info = {0};
        dladdr(node-&gt;pc, &amp;info);

        NSString * name = @(info.dli_sname);
        free(node);
        
        BOOL isObjc = [name hasPrefix:@&quot;+[&quot;]||[name hasPrefix:@&quot;-[&quot;];
        NSString * symbolName = isObjc ? name : [@&quot;_&quot; stringByAppendingString:name];
        [symbolNames addObject:symbolName];
    }
    //反向数组
    NSEnumerator * enumerator = [symbolNames reverseObjectEnumerator];
    
    //创建一个新数组
    NSMutableArray * funcs = [NSMutableArray arrayWithCapacity:symbolNames.count];
    NSString * name;
    //去重!
    while (name = [enumerator nextObject]) {
        if (![funcs containsObject:name]) {//数组中不包含name
            [funcs addObject:name];
        }
    }
    [funcs removeObject:[NSString stringWithFormat:@&quot;%s&quot;,__FUNCTION__]];
    //数组转成字符串
    NSString * funcStr = [funcs componentsJoinedByString:@&quot;\n&quot;];
    
    NSString * filePath = [NSTemporaryDirectory() stringByAppendingPathComponent:@&quot;xzOrder.order&quot;];

    //文件内容
    NSData * fileContents = [funcStr dataUsingEncoding:NSUTF8StringEncoding];
    BOOL success = [[NSFileManager defaultManager] createFileAtPath:filePath contents:fileContents attributes:nil];
    
    NSLog(success?@&quot;成功&quot;:@&quot;失败&quot;);
}
</code></pre></div><p>也可以直接使用c函数写这个方法，前面加上导出符号extern。在别的文件内可以直接调用</p> <p>5、拿到生成的order文件。由于是在真机上运行，文件也是存在真机沙盒中，可以通过如下方式下载手机上的app沙盒文件</p> <p><img src="http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/1240-20221209213917314.png" alt="下载沙盒.png"></p> <p>6、配置沙盒文件到xcode中，在build setting中找到Order file选项，配置order文件的地址</p> <p>7、结束了，多次重启手机，测量启动时间，以及Page Fault次数，然后求平均值，得到的结果是启动时间大约加快了10%-15%左右。如图</p> <p><img src="http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/1240-20221209213924656.png" alt="对比.png"></p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>优化手段都是辅助，主要的还是要养成好的代码习惯。开发过程中梳理好架构，合理取舍，减少动态库、ObjC类的数目，减少Category的数目。</p> <p>废弃的代码文件或者资源文件及时删除。当然也可以使用脚本定期排查，后面我也会写相应脚本并补充上来</p> <p>合理使用手机多核性能，避免主线程大量工作影响效率</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/topic/%E9%9F%B3%E8%A7%86%E9%A2%91/%E9%9F%B3%E8%A7%86%E9%A2%91--%E5%A3%B0%E9%9F%B3/"><div>
            音视频--声音
            <!----></div></a> <span class="date">03-10</span></dt></dl><dl><dd>02</dd> <dt><a href="/topic/%E9%9F%B3%E8%A7%86%E9%A2%91/"><div>
            音视频
            <!----></div></a> <span class="date">03-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/posts/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"><div>
            docker常用命令
            <!----></div></a> <span class="date">03-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2015-2023
    <span>LuckyXYJ | <a href="http://beian.miit.gov.cn/">豫ICP备2021029639号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.93bd62be.js" defer></script><script src="/assets/js/2.7f06bbfc.js" defer></script><script src="/assets/js/45.6248b108.js" defer></script>
  </body>
</html>
