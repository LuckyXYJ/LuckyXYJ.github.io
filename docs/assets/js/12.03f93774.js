(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{317:function(_,a,t){"use strict";t.r(a);var o=t(6),s=Object(o.a)({},(function(){var _=this,a=_._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[a("h2",{attrs:{id:"block本质"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block本质"}},[_._v("#")]),_._v(" Block本质")]),_._v(" "),a("p",[_._v("block本质上也是一个OC对象，它内部也有个isa指针")]),_._v(" "),a("p",[_._v("block是封装了"),a("strong",[_._v("函数调用")]),_._v("以及"),a("strong",[_._v("函数调用环境")]),_._v("的"),a("strong",[_._v("OC对象")])]),_._v(" "),a("p",[_._v("block的底层结构如下图所示")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601203643653.png",alt:"image-20220601203643653"}})]),_._v(" "),a("h2",{attrs:{id:"block变量捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block变量捕获"}},[_._v("#")]),_._v(" Block变量捕获")]),_._v(" "),a("table",[a("thead",[a("tr",[a("th",[a("strong",[_._v("变量类型")])]),_._v(" "),a("th",[a("strong",[_._v("捕获到block 内部")])]),_._v(" "),a("th",[a("strong",[_._v("访问方式")])])])]),_._v(" "),a("tbody",[a("tr",[a("td",[_._v("局部auto变量")]),_._v(" "),a("td",[_._v("√")]),_._v(" "),a("td",[_._v("值传递")])]),_._v(" "),a("tr",[a("td",[_._v("局部static变量")]),_._v(" "),a("td",[_._v("√")]),_._v(" "),a("td",[_._v("指针传递")])]),_._v(" "),a("tr",[a("td",[_._v("全局变量")]),_._v(" "),a("td",[_._v("×")]),_._v(" "),a("td",[_._v("直接访问")])])])]),_._v(" "),a("h3",{attrs:{id:"auto变量的捕获"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#auto变量的捕获"}},[_._v("#")]),_._v(" Auto变量的捕获")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601204042313.png",alt:"image-20220601204042313"}})]),_._v(" "),a("h2",{attrs:{id:"block类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block类型"}},[_._v("#")]),_._v(" block类型")]),_._v(" "),a("p",[_._v("block有3种类型，可以通过调用class方法或者isa指针查看具体类型，最终都是继承自NSBlock类型")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("__NSGlobalBlock__ （ _NSConcreteGlobalBlock ）\n\n__NSStackBlock__ （ _NSConcreteStackBlock ）\n\n__NSMallocBlock__ （ _NSConcreteMallocBlock ）\n")])])]),a("table",[a("thead",[a("tr",[a("th",[_._v("**block ** "),a("strong",[_._v("类型")])]),_._v(" "),a("th",[a("strong",[_._v("环境")])])])]),_._v(" "),a("tbody",[a("tr",[a("td",[a("strong",[_._v("NSGlobalBlock")])]),_._v(" "),a("td",[_._v("没有访问auto变量")])]),_._v(" "),a("tr",[a("td",[a("em",[a("em",[_._v("NSStackBlock")])])]),_._v(" "),a("td",[_._v("访问了auto变量")])]),_._v(" "),a("tr",[a("td",[a("em",[a("em",[_._v("NSMallocBlock")])])]),_._v(" "),a("td",[_._v("__NSStackBlock__调用了copy")])])])]),_._v(" "),a("p",[_._v("每一种类型的block调用copy后的结果如下所示")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601205102084.png",alt:"image-20220601205102084"}})]),_._v(" "),a("h2",{attrs:{id:"block-的copy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block-的copy"}},[_._v("#")]),_._v(" Block 的copy")]),_._v(" "),a("p",[_._v("在ARC环境下，编译器会根据情况自动将栈上的block复制到堆上，比如以下情况")]),_._v(" "),a("ul",[a("li",[_._v("block作为函数返回值时")]),_._v(" "),a("li",[_._v("将block赋值给__strong指针时")]),_._v(" "),a("li",[_._v("block作为Cocoa API中方法名含有usingBlock的方法参数时")]),_._v(" "),a("li",[_._v("block作为GCD API的方法参数时")])]),_._v(" "),a("p",[_._v("MRC下block属性的建议写法")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("@property (copy, nonatomic) void (^block)(void);\n")])])]),a("p",[_._v("ARC下block属性的建议写法")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("@property (strong, nonatomic) void (^block)(void);\n\n@property (copy, nonatomic) void (^block)(void);\n")])])]),a("h2",{attrs:{id:"访问对象类型的auto变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问对象类型的auto变量"}},[_._v("#")]),_._v(" 访问对象类型的auto变量")]),_._v(" "),a("p",[_._v("当block内部访问了对象类型的auto变量时")]),_._v(" "),a("p",[a("strong",[_._v("如果block是在栈上")]),_._v("，将不会对auto变量产生强引用")]),_._v(" "),a("p",[a("strong",[_._v("如果block被拷贝到堆上")])]),_._v(" "),a("ul",[a("li",[_._v("会调用block内部的copy函数")]),_._v(" "),a("li",[_._v("copy函数内部会调用_Block_object_assign函数_")]),_._v(" "),a("li",[_._v("Block_object_assign函数会根据auto变量的修饰符（__strong、__weak、__unsafe_unretained）做出相应的操作，形成强引用（retain）或者弱引用")])]),_._v(" "),a("p",[a("strong",[_._v("如果block从堆上移除")])]),_._v(" "),a("ul",[a("li",[_._v("会调用block内部的dispose函数")]),_._v(" "),a("li",[_._v("dispose函数内部会调用_Block_object_dispose函数_")]),_._v(" "),a("li",[_._v("Block_object_dispose函数会自动释放引用的auto变量（release）")])]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601205629873.png",alt:"image-20220601205629873"}})]),_._v(" "),a("h2",{attrs:{id:"weak问题解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#weak问题解决"}},[_._v("#")]),_._v(" __weak问题解决")]),_._v(" "),a("p",[_._v("在使用clang转换OC为C++代码时，可能会遇到以下问题")]),_._v(" "),a("p",[_._v("cannot create __weak reference in file using manual reference")]),_._v(" "),a("p",[_._v("解决方案：支持ARC、指定运行时系统版本，比如")]),_._v(" "),a("p",[_._v("xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 main.m")]),_._v(" "),a("h2",{attrs:{id:"block修饰符"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block修饰符"}},[_._v("#")]),_._v(" __block修饰符")]),_._v(" "),a("p",[_._v("__block可以用于解决block内部无法修改auto变量值的问题")]),_._v(" "),a("p",[_._v("__block不能修饰全局变量、静态变量（static）")]),_._v(" "),a("p",[_._v("编译器会将__block变量包装成一个对象")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601205841942.png",alt:"image-20220601205841942"}})]),_._v(" "),a("h2",{attrs:{id:"block的内存管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block的内存管理"}},[_._v("#")]),_._v(" __Block的内存管理")]),_._v(" "),a("p",[_._v("当block在栈上时，并不会对__block变量产生强引用")]),_._v(" "),a("p",[_._v("当block被"),a("strong",[_._v("copy到堆时")])]),_._v(" "),a("ul",[a("li",[_._v("会调用block内部的copy函数")]),_._v(" "),a("li",[_._v("copy函数内部会调用_Block_object_assign函数_")]),_._v(" "),a("li",[_._v("Block_object_assign函数会对__block变量形成强引用（retain）")])]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601210012513.png",alt:"image-20220601210012513"}})]),_._v(" "),a("p",[_._v("当block"),a("strong",[_._v("从堆中移除时")])]),_._v(" "),a("ul",[a("li",[_._v("会调用block内部的dispose函数")]),_._v(" "),a("li",[_._v("dispose函数内部会调用_Block_object_dispose函数_")]),_._v(" "),a("li",[_._v("Block_object_dispose函数会自动释放引用的__block变量（release）")])]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601224842718.png",alt:"image-20220601224842718"}})]),_._v(" "),a("h2",{attrs:{id:"block的forwarding指针"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#block的forwarding指针"}},[_._v("#")]),_._v(" block的forwarding指针")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601224935611.png",alt:"image-20220601224935611"}})]),_._v(" "),a("h2",{attrs:{id:"对象类型的auto变量-block变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对象类型的auto变量-block变量"}},[_._v("#")]),_._v(" 对象类型的auto变量，__block变量")]),_._v(" "),a("p",[_._v("当block在"),a("strong",[_._v("栈上")]),_._v("时，对它们都不会产生强引用")]),_._v(" "),a("p",[_._v("当block"),a("strong",[_._v("拷贝到堆上")]),_._v("时，都会通过copy函数来处理它们")]),_._v(" "),a("p",[_._v("__block变量（假设变量名叫做a）")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("_Block_object_assign((void*)&dst->a, (void*)src->a, 8/*BLOCK_FIELD_IS_BYREF*/);\n")])])]),a("p",[_._v("对象类型的auto变量（假设变量名叫做p）")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("_Block_object_assign((void*)&dst->p, (void*)src->p, 3/*BLOCK_FIELD_IS_OBJECT*/);\n")])])]),a("p",[_._v("当block"),a("strong",[_._v("从堆上移除")]),_._v("时，都会通过dispose函数来释放它们")]),_._v(" "),a("p",[_._v("__block变量（假设变量名叫做a）")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("_Block_object_dispose((void*)src->a, 8/*BLOCK_FIELD_IS_BYREF*/);\n")])])]),a("p",[_._v("对象类型的auto变量（假设变量名叫做p）")]),_._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[_._v("_Block_object_dispose((void*)src->p, 3/*BLOCK_FIELD_IS_OBJECT*/);\n")])])]),a("h2",{attrs:{id:"被-block修饰的对象类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#被-block修饰的对象类型"}},[_._v("#")]),_._v(" 被__block修饰的对象类型")]),_._v(" "),a("p",[_._v("当__block变量在栈上时，不会对指向的对象产生强引用")]),_._v(" "),a("p",[_._v("当__block变量被copy到堆时")]),_._v(" "),a("ul",[a("li",[_._v("会调用__block变量内部的copy函数_")]),_._v(" "),a("li",[_._v("_copy函数内部会调用_Block_object_assign函数")]),_._v(" "),a("li",[_._v("_Block_object_assign函数会根据所指向对象的修饰符（ __strong、__weak、__unsafe_unretained）做出相应的操作，形成强引用（retain）或者弱引用（注意：这里仅限于ARC时会retain，MRC时不会retain）")])]),_._v(" "),a("p",[_._v("如果__block变量从堆上移除")]),_._v(" "),a("ul",[a("li",[_._v("会调用__block变量内部的dispose函数_")]),_._v(" "),a("li",[_._v("_dispose函数内部会调用_Block_object_dispose函数")]),_._v(" "),a("li",[_._v("_Block_object_dispose函数会自动释放指向的对象（release）")])]),_._v(" "),a("h2",{attrs:{id:"解决循环引用问题-arc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决循环引用问题-arc"}},[_._v("#")]),_._v(" 解决循环引用问题 - ARC")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601230342280.png",alt:"image-20220601230342280"}})]),_._v(" "),a("h2",{attrs:{id:"解决循环引用问题-mrc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决循环引用问题-mrc"}},[_._v("#")]),_._v(" 解决循环引用问题 - MRC")]),_._v(" "),a("p",[a("img",{attrs:{src:"http://xingyajie.oss-cn-hangzhou.aliyuncs.com/uPic/image-20220601230407473.png",alt:"image-20220601230407473"}})]),_._v(" "),a("h2",{attrs:{id:"weak-strong作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#weak-strong作用"}},[_._v("#")]),_._v(" __weak, __strong作用")]),_._v(" "),a("p",[_._v("__weak typeof(self) wself = self;")]),_._v(" "),a("p",[_._v("__strong typeof(self) sself = wself;")]),_._v(" "),a("p",[_._v("__weak弱引用指针，避免循环引用")]),_._v(" "),a("p",[_._v("__strong避免在使用过程中，对象被销毁")])])}),[],!1,null,null,null);a.default=s.exports}}]);